(function(){(function(){const e=window!==window.top;console.log("[CONTENT] Starting injection in",e?"IFRAME":"TOP FRAME"),console.log("[CONTENT] Current URL:",window.location.href),document.documentElement.setAttribute("data-debug-mode","true");const t=document.createElement("script");t.src=chrome.runtime.getURL("src/interceptor.js"),t.onload=function(){console.log("[CONTENT] Interceptor injected successfully"),this.remove()},t.onerror=function(){console.error("[CONTENT] Failed to load interceptor!")},(document.head||document.documentElement).appendChild(t);const n=document.createElement("script");n.src=chrome.runtime.getURL("src/bot.js"),n.onload=function(){console.log("[CONTENT] Bot script injected successfully"),this.remove()},(document.head||document.documentElement).appendChild(n)})();const m=window!==window.top;let a={detected:!1,initialized:!1,gameData:null,balance:null,availableBets:[],sessionActive:!1},o=!1,i=null;function s(e){return new Promise(t=>{if(!chrome.runtime?.id){console.log("[CONTENT] Extension context lost"),t(null);return}chrome.runtime.sendMessage(e,n=>{chrome.runtime.lastError?(console.log("[CONTENT] Message error:",chrome.runtime.lastError.message),t(null)):t(n)})})}async function u(){const e=await s({type:"GET_TAB_ID"});e&&e.tabId&&(i=e.tabId,console.log("[CONTENT] Tab ID:",i))}let r=!1;function c(){if(r)return;r=!0;const e=document.createElement("script");e.src=chrome.runtime.getURL("src/checker.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}window.addEventListener("message",function(e){if(e.source!==window)return;const t=e.data;if(!(!t||!t.type||!o&&["GAME_DATA_CAPTURED","AVAILABLE_BETS_UPDATE","INIT_RESPONSE","BALANCE_UPDATE","BOT_LOG","BOT_STATS"].includes(t.type)&&t.type!=="HAS_GAME_SERVICE"))switch(t.type){case"HAS_GAME_SERVICE":o||(o=!0,console.log("[CONTENT] GameService detected in this frame!"));break;case"GAME_DATA_CAPTURED":console.log("[CONTENT] Game data captured:",t.data),T(t.data),t.availableBets&&l(t.availableBets);break;case"AVAILABLE_BETS_UPDATE":console.log("[CONTENT] Available bets:",t.availableBets),l(t.availableBets);break;case"INIT_RESPONSE":console.log("[CONTENT] Init response - index:",t.index,"counter:",t.counter),a.gameData&&(a.gameData.index=t.index,a.gameData.counter=t.counter);break;case"MGCKEY_UPDATE":a.gameData&&(a.gameData.mgckey=t.mgckey);break;case"BALANCE_UPDATE":a.balance=t.balance,s({type:"BALANCE_UPDATE",data:{balance:t.balance,action:t.action}});break;case"BOT_LOG":s({type:"BOT_LOG",message:t.message,level:t.level,timestamp:t.timestamp});break;case"BOT_STATS":s({type:"BOT_STATS",stats:t.stats});break}});async function T(e){console.log("[CONTENT] Game detected:",e),a.detected=!0,a.initialized=!0,a.gameData=e,a.sessionActive=!0,await s({type:"GAME_DETECTED",data:{url:window.location.href,origin:e.origin,symbol:e.symbol,mgckey:e.mgckey,requestUrl:e.requestUrl,index:e.index,counter:e.counter,timestamp:e.timestamp,isIframe:m}});const t=i;if(t){const n=`gameData_${t}`;await chrome.storage.local.set({[n]:{detected:!0,initialized:!0,gameData:e,timestamp:new Date().toISOString()}}),console.log("[CONTENT] Stored game data for tab:",t)}}async function l(e){console.log("[CONTENT] Bets detected:",e),a.availableBets=e,await chrome.storage.local.set({availableBets:e}),await s({type:"BETS_UPDATE",data:{availableBets:e}})}function E(e){return a.gameData?o?(console.log("[CONTENT] Starting bot with settings:",e),console.log("[CONTENT] Game data:",a.gameData),document.documentElement.setAttribute("data-bot-settings",JSON.stringify(e)),document.documentElement.setAttribute("data-game-data",JSON.stringify(a.gameData)),document.documentElement.setAttribute("data-bot-command","start"),window.postMessage({type:"BOT_COMMAND",command:"start",settings:e,gameData:a.gameData},"*"),!0):(console.log("[CONTENT] No gameService in this frame, skipping"),!1):(console.log("[CONTENT] No game data in this frame, skipping"),!1)}function g(){console.log("[CONTENT] Stopping bot"),document.documentElement.setAttribute("data-bot-command","stop"),window.postMessage({type:"BOT_COMMAND",command:"stop"},"*")}chrome.runtime.onMessage.addListener((e,t,n)=>{switch(console.log("[CONTENT] Message from extension:",e.type),e.type){case"GET_GAME_STATE":n({state:a,url:window.location.href,hasGameService:o});break;case"CHECK_GAME":n({detected:a.detected,initialized:a.initialized,hasGameService:o});break;case"START_BOT":const d=E(e.settings);n({success:d,hasGameData:!!a.gameData});break;case"STOP_BOT":g(),n({success:!0});break;case"RESET_STATE":a={detected:!1,initialized:!1,gameData:null,balance:null,availableBets:[],sessionActive:!1},n({reset:!0});break;default:n({error:"Unknown request type"})}return!0});console.log("[CONTENT] Initializing game data capture...");u();c();setTimeout(c,100);setTimeout(c,500);setTimeout(c,1500);let f=setInterval(()=>{a.detected?clearInterval(f):o||c()},2e3);window.addEventListener("beforeunload",()=>{a.sessionActive&&s({type:"SESSION_END",data:{gameData:a.gameData,finalBalance:a.balance}})});
})()
