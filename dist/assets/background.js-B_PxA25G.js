let l=new Map,g={},n=[];async function f(){try{return g=await(await fetch(chrome.runtime.getURL("strategy.json"))).json(),console.log("[BG] Strategy loaded successfully"),!0}catch(a){return console.error("[BG] Failed to load strategy:",a),!1}}function d(a,t){const e=t==="A"||t==="11"||t==="1"?"1/11":t.toString();if(g[e]&&g[e][a])return{success:!0,action:g[e][a],playerHand:a,dealerCard:t};const s=parseInt(a);return isNaN(s)?{success:!0,action:"Stand"}:s<=11?{success:!0,action:"Hit"}:s>=17?{success:!0,action:"Stand"}:{success:!0,action:"Hit"}}chrome.runtime.onMessage.addListener((a,t,e)=>{switch(console.log("[BG] Message:",a.type),a.type){case"GET_TAB_ID":t.tab?e({tabId:t.tab.id}):e({error:"No tab ID available"});break;case"GAME_DETECTED":if(t.tab){const c=t.tab.id;l.set(c,{detected:!0,initialized:!0,gameData:a.data,timestamp:new Date().toISOString()}),console.log("[BG] Game detected on tab",c),e({success:!0,tabId:c})}break;case"SESSION_UPDATE":if(t.tab){const c=t.tab.id,o=l.get(c);o&&o.gameData&&(o.gameData.mgckey=a.data.mgckey),e({success:!0})}break;case"BETS_UPDATE":if(t.tab){const c=t.tab.id,o=l.get(c);o&&(o.availableBets=a.data.availableBets),chrome.storage.local.set({availableBets:a.data.availableBets}),e({success:!0})}break;case"BALANCE_UPDATE":if(t.tab){const c=t.tab.id,o=l.get(c);o&&(o.balance=a.data.balance),e({success:!0})}break;case"BOT_LOG":n.push({message:a.message,level:a.level,timestamp:a.timestamp||new Date().toLocaleTimeString()}),n.length>100&&(n=n.slice(-100)),e({success:!0});break;case"BOT_STATS":chrome.storage.local.set({botStats:a.stats}),e({success:!0});break;case"GET_BOT_LOGS":e({logs:n});break;case"SESSION_END":if(t.tab){const c=t.tab.id;l.delete(c),console.log("[BG] Session ended for tab",c),e({success:!0})}break;case"START_GAME":return chrome.tabs.query({active:!0,currentWindow:!0},async c=>{if(c[0]){const o=c[0].id;chrome.storage.local.set({betSize:a.data.betSize,targetWager:a.data.targetWager,actionDelay:a.data.actionDelay});const m=await chrome.webNavigation.getAllFrames({tabId:o});console.log("[BG] Sending START_BOT to",m.length,"frames");for(const u of m)try{chrome.tabs.sendMessage(o,{type:"START_BOT",settings:a.data},{frameId:u.frameId},b=>{chrome.runtime.lastError||b&&b.success&&console.log("[BG] Bot started in frame",u.frameId)})}catch{}e({success:!0})}}),!0;case"STOP_GAME":return chrome.tabs.query({active:!0,currentWindow:!0},async c=>{if(c[0]){const o=c[0].id,m=await chrome.webNavigation.getAllFrames({tabId:o});for(const u of m)try{chrome.tabs.sendMessage(o,{type:"STOP_BOT"},{frameId:u.frameId})}catch{}e({success:!0})}}),!0;case"ANALYZE_HAND":const s=d(a.data.playerHand,a.data.dealerCard);e(s);break;case"LOAD_STRATEGY":return f().then(c=>e({success:c})).catch(c=>e({success:!1,error:c.message})),!0;case"UPDATE_SETTINGS":return chrome.storage.local.set(a.data).then(()=>e({success:!0})).catch(c=>e({success:!1,error:c.message})),!0;case"GET_STATUS":const i=t.tab?t.tab.id:null,r=i?l.get(i):null;e({hasGameData:r!==null,gameDetected:r?r.detected:!1,gameInitialized:r?r.initialized:!1,strategyLoaded:Object.keys(g).length>0,activeGamesCount:l.size,tabData:r||null,tabId:i});break;default:e({success:!1,error:"Unknown message type"})}});chrome.tabs.onRemoved.addListener(async a=>{console.log("[BG] Tab closed:",a),l.delete(a);const t=[`gameData_${a}`,`botStatus_${a}`,`tabStats_${a}`,`tabHasGame_${a}`];await chrome.storage.local.remove(t),console.log("[BG] Cleaned up data for tab:",a)});chrome.tabs.onUpdated.addListener(async(a,t,e)=>{if(t.status==="loading"){console.log("[BG] Tab navigating/refreshing:",a),l.delete(a);const s=`autoRefresh_${a}`,i=await chrome.storage.local.get([s]),r=[`gameData_${a}`,`tabHasGame_${a}`];i[s]?(await chrome.storage.local.remove([s]),console.log("[BG] Preserving stats (auto-refresh cycle)")):(r.push("botStats","botRunning"),console.log("[BG] Clearing stats and bot state (not auto-refresh)")),await chrome.storage.local.remove(r),console.log("[BG] Cleared game data for tab refresh:",a)}});chrome.runtime.onInstalled.addListener(()=>{console.log("[BG] Blackjack Bot Extension installed"),f()});f();console.log("[BG] Background script loaded");
